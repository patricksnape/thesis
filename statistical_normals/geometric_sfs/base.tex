%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Geometric Shape-from-Shading With Kernels}\label{sec:singl_img_gsfs}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Geometric Shape-from-Shading (GSFS) is the name given by
\cite{smith2006recovering,worthington1999new,smith2008facial} to their
SfS algorithm for statistical
reconstruction of surface normals. Although we have chosen to place all KPCA
kernels within this algorithm, we would stress that this is merely to provide a
practical demonstration of the power of the proposed kernel component analysis.
The use of a statistical prior, however, does produce superior results when
compared to state-of-the-art SfS techniques that have no prior knowledge of
object shape. A comparison of GSFS to a generic state-of-the-art SfS algorithm
is given in \cref{subsec:sfs-compare}.

GSFS extends the SfS algorithm given by \citet{worthington1999new} to include a
statistical prior on normals. The algorithm
is simple to compute and produces results that are visually appealing and
guaranteed to represent the space of faces. They initialise the normals by
assuming global convexity, and then proceed to iterate by first reconstructing
the normals using the PCA model and then enforcing the hard-irradiance
constraint. The hard-irradiance constraint is enforced by rotating the
potentially off-cone reconstructed surface normal back onto the reflectance cone
specified by the light direction and intensity of a given pixel. An overview of
the algorithm is given in \cref{alg:gsfs}. We augment the original GSFS
algorithm by replacing the statistical reconstruction step with each of the
kernels detailed in \cref{subsec:singl_img_ca}.

In the case of SfS, we assume our input to be a set of normal vectors describing
a surface $z(x, y)$ as a set of local surface normals $\bb{n}(x, y)$ projected
on to the view plane. When reconstructing using component analysis, the normals
have been concatenated into a column vector $\bb{x}$ as described in
\cref{subsec:singl_img_ca}.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
{
\alglanguage{pseudocode}
\begin{algorithm}[t]
\caption{{\sc Geometric Shape-from-Shading}}
\label{alg:gsfs}
	\algrenewcommand{\alglinenumber}[1]{(#1)}
    \begin{algorithmic}[1]
        \While{$\sum_{i,j} \arccos \left({\bb{n}(i, j)}' \cdot {\bb{n}(i, j)}'' \right) < \epsilon$}
            \State{}Calculate an initial estimate of the surface normals.
            \State{}Project the normals into the feature space using one of the projection operators from \cref{subsec:singl_img_ca}: $\phi_{F}(\bb{x})$
            \State{}Reconstruct the best fit feature space vector: $\bb{U}_{F} {\bb{U}_{F}}^T \phi_{F}(\bb{x})$.
            \State{}Use the inverse mapping to recreate a set of surface normals, ${x}' = {\phi_{F}}^{-1} \left( \bb{U}_{F} {\bb{U}_{F}}^T \phi_{F}(\bb{x}) \right)$, with individual normals ${\bb{n}(i, j)}'$
            \State{}Enforce hard-irradiance constraint on the reconstructed normals to find the on-cone surface normal, ${\bb{n}(i, j)}''$.
    	\EndWhile{}
    \end{algorithmic}
\end{algorithm}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
{ % Commands
\newcommand{\origimg}[1]{
    \begin{subfigure}[b]{0.11\textwidth}
            \centering
            \includegraphics[width=\textwidth]{statistical_normals/images/gsfs_results/photoface/#1.png}
\label{fig:results-photoface-input-#1}
    \end{subfigure}
}
\newcommand{\origimgtop}[2]{
    \begin{subfigure}[t]{0.11\textwidth}
            \centering
            \caption*{#2}
            \includegraphics[width=\textwidth]{statistical_normals/images/gsfs_results/photoface/#1.png}
\label{fig:results-photoface-input-#1}
    \end{subfigure}
}
\newcommand{\sfsimgs}[2]{
    \begin{subfigure}[b]{0.11\textwidth}
            \centering
            \includegraphics[width=\textwidth]{statistical_normals/images/gsfs_results/photoface/#1_#2.png}
\label{fig:results-photoface-#1-#2}
    \end{subfigure}
}
\newcommand{\sfsimgstop}[3]{
    \begin{subfigure}[t]{0.11\textwidth}
            \centering
            \caption*{#2}
            \includegraphics[width=\textwidth]{statistical_normals/images/gsfs_results/photoface/#1_#3.png}
\label{fig:results-photoface-#1-#3}
    \end{subfigure}
}

\newcommand{\sfsimgsalltop}[1]{
    \origimgtop{#1}{Input Image}
    \sfsimgstop{#1}{GT}{ground_truth}
    \sfsimgstop{#1}{AEP}{aep}
    \sfsimgstop{#1}{IP}{cosine}
    \sfsimgstop{#1}{PGA}{pga}
    \sfsimgstop{#1}{SPHER}{spherical}
    \sfsimgstop{#1}{SIRFS~\cite{barron2015shape}}{sirfs}
}

\newcommand{\sfsimgsall}[1]{
    \origimg{#1}
    \sfsimgs{#1}{ground_truth}
    \sfsimgs{#1}{aep}
    \sfsimgs{#1}{cosine}
    \sfsimgs{#1}{pga}
    \sfsimgs{#1}{spherical}
    \sfsimgs{#1}{sirfs}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{statistical_normals/geometric_sfs/experiments}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
